# å°ä¾¿æ± è·¯å¾„è§„åˆ’å™¨ - PCDæ–‡ä»¶ç‰ˆæœ¬

## ðŸ“‹ æ¦‚è¿°

`urinal_path_planner_pcd.py` æ˜¯ä¸€ä¸ª**ç‹¬ç«‹çš„Pythonè„šæœ¬**ï¼Œç”¨äºŽä»ŽPCDç‚¹äº‘æ–‡ä»¶ç”Ÿæˆå°ä¾¿æ± æ¸…æ´è·¯å¾„å¹¶è¿›è¡Œå¯è§†åŒ–ã€‚

**ä¸ŽROSç‰ˆæœ¬çš„åŒºåˆ«ï¼š**
- âŒ **ç§»é™¤**ï¼šROSä¾èµ–ã€ROIè£å‰ªåŠŸèƒ½ã€å®žæ—¶è®¢é˜…
- âœ… **ä¿ç•™**ï¼šæ‰€æœ‰æ ¸å¿ƒè·¯å¾„è§„åˆ’ç®—æ³•ï¼ˆèžºæ—‹ã€Alpha Shapeï¼‰
- ðŸŽ¯ **ç®€åŒ–**ï¼šç›´æŽ¥è¯»å–PCDæ–‡ä»¶ï¼Œè¾“å‡ºæ–‡æœ¬è·¯å¾„ï¼Œå¯è§†åŒ–ç»“æžœ

---

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºæœ¬ç”¨æ³•

```bash
# ä»ŽPCDæ–‡ä»¶ç”Ÿæˆè·¯å¾„å¹¶å¯è§†åŒ–
python3 urinal_path_planner_pcd.py --input your_urinal.pcd --visualize
```

### 2. ä¿å­˜ç»“æžœ

```bash
# ç”Ÿæˆè·¯å¾„å¹¶ä¿å­˜åˆ°æ–‡ä»¶
python3 urinal_path_planner_pcd.py \
    --input urinal.pcd \
    --output my_path.txt \
    --visualize
```

### 3. è‡ªå®šä¹‰å‚æ•°

```bash
# ä½¿ç”¨èžºæ—‹ç®—æ³•ï¼Œ15å±‚ï¼Œæ›´ç»†çš„ä½“ç´ 
python3 urinal_path_planner_pcd.py \
    --input urinal.pcd \
    --algorithm spiral \
    --layers 15 \
    --voxel 0.003 \
    --visualize
```

---

## ðŸ“¦ ä¾èµ–å®‰è£…

```bash
# å®‰è£…Open3D
pip install open3d

# å®‰è£…å…¶ä»–ä¾èµ–
pip install numpy scipy scikit-learn
```

---

## ðŸ”§ å‘½ä»¤è¡Œå‚æ•°

### å¿…éœ€å‚æ•°

| å‚æ•° | è¯´æ˜Ž |
|------|------|
| `--input PATH` | è¾“å…¥PCDæ–‡ä»¶è·¯å¾„ |

### å¯é€‰å‚æ•°

#### è¾“å‡ºæŽ§åˆ¶
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| `--output PATH` | `output_path.txt` | è¾“å‡ºè·¯å¾„æ–‡ä»¶ |
| `--visualize` | å…³é—­ | æ˜¾ç¤º3Då¯è§†åŒ–çª—å£ |
| `--save-vis PATH` | æ—  | ä¿å­˜å¯è§†åŒ–æˆªå›¾ |

#### ç®—æ³•é€‰æ‹©
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| `--algorithm TYPE` | `alpha_shape` | è·¯å¾„ç®—æ³•ï¼š`spiral` æˆ– `alpha_shape` |

#### é¢„å¤„ç†å‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| `--voxel FLOAT` | `0.005` | ä½“ç´ ä¸‹é‡‡æ ·å¤§å°ï¼ˆç±³ï¼‰|
| `--trim-top FLOAT` | `0.02` | é¡¶éƒ¨è£å‰ªé«˜åº¦ï¼ˆç±³ï¼‰|
| `--trim-bottom FLOAT` | `0.00` | åº•éƒ¨è£å‰ªé«˜åº¦ï¼ˆç±³ï¼‰|

#### Alpha Shapeå‚æ•°
| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜Ž |
|------|--------|------|
| `--alpha FLOAT` | `0.20` | Alpha Shapeå‚æ•°ï¼ˆè¶Šå°è¶Šç´§å¯†ï¼‰|
| `--layers INT` | `10` | åˆ†å±‚æ•°é‡ |
| `--point-distance FLOAT` | `0.01` | è·¯å¾„ç‚¹é—´è·ï¼ˆç±³ï¼‰|

---

## ðŸ“‚ è¾“å…¥/è¾“å‡ºæ ¼å¼

### è¾“å…¥ï¼šPCDæ–‡ä»¶

æ”¯æŒçš„æ ¼å¼ï¼š
- `.pcd` (Point Cloud Data) - æ ‡å‡†Open3Dæ ¼å¼
- å¿…é¡»åŒ…å«XYZåæ ‡
- å¯é€‰åŒ…å«æ³•å‘é‡ï¼ˆä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ï¼‰

**ç¤ºä¾‹PCDæ–‡ä»¶èŽ·å–æ–¹å¼ï¼š**
```bash
# æ–¹æ³•1: ä»ŽROS bagè½¬æ¢
rosrun pcl_ros bag_to_pcd your_bag.bag /camera/depth/points ./output_dir

# æ–¹æ³•2: ä»ŽRealSenseä¿å­˜
# ä½¿ç”¨RealSense Viewerç›´æŽ¥ä¿å­˜

# æ–¹æ³•3: ä»Žå·²æœ‰ROSèŠ‚ç‚¹ä¿å­˜
rosrun pcl_ros pointcloud_to_pcd input:=/target_pointcloud
```

### è¾“å‡ºï¼šæ–‡æœ¬è·¯å¾„æ–‡ä»¶

æ ¼å¼ç¤ºä¾‹ï¼ˆ`output_path.txt`ï¼‰ï¼š
```
# å°ä¾¿æ± æ¸…æ´è·¯å¾„
# æ ¼å¼: x y z roll pitch yaw
# æ€»ç‚¹æ•°: 523
# ç”Ÿæˆç®—æ³•: alpha_shape
#
0.123456 0.234567 0.345678 0.000000 0.523599 1.570796
0.124567 0.235678 0.346789 0.000000 0.524698 1.571895
...
```

**6åˆ—å«ä¹‰ï¼š**
1. `x` - Xåæ ‡ï¼ˆç±³ï¼‰
2. `y` - Yåæ ‡ï¼ˆç±³ï¼‰
3. `z` - Zåæ ‡ï¼ˆç±³ï¼‰
4. `roll` - æ»šè½¬è§’ï¼ˆå¼§åº¦ï¼‰
5. `pitch` - ä¿¯ä»°è§’ï¼ˆå¼§åº¦ï¼‰
6. `yaw` - åèˆªè§’ï¼ˆå¼§åº¦ï¼‰

---

## ðŸŽ¨ å¯è§†åŒ–è¯´æ˜Ž

å¯ç”¨ `--visualize` åŽï¼Œä¼šæ‰“å¼€3Däº¤äº’çª—å£ï¼š

### å¯è§†åŒ–å…ƒç´ 

| å…ƒç´  | é¢œè‰² | è¯´æ˜Ž |
|------|------|------|
| ç‚¹äº‘ | ç°è‰² | åŽŸå§‹/é¢„å¤„ç†åŽçš„ç‚¹äº‘ |
| è·¯å¾„çº¿æ¡ | çº¢è‰² | ç”Ÿæˆçš„æ¸…æ´è·¯å¾„ |
| æ³•å‘é‡ç®­å¤´ | ç»¿è‰² | å·¥å…·å§¿æ€æ–¹å‘ |
| èµ·ç‚¹çƒ | è“è‰² | è·¯å¾„èµ·å§‹ç‚¹ |
| ç»ˆç‚¹çƒ | ç»¿è‰² | è·¯å¾„ç»“æŸç‚¹ |
| åæ ‡ç³» | RGBè½´ | X=çº¢, Y=ç»¿, Z=è“ |

### æ“ä½œæ–¹å¼

- **æ—‹è½¬**ï¼šé¼ æ ‡å·¦é”®æ‹–åŠ¨
- **ç¼©æ”¾**ï¼šé¼ æ ‡æ»šè½®
- **å¹³ç§»**ï¼šé¼ æ ‡å³é”®æ‹–åŠ¨
- **æˆªå›¾**ï¼šæŒ‰ `S` é”®ï¼ˆä¿å­˜åˆ°å½“å‰ç›®å½•ï¼‰
- **é€€å‡º**ï¼šå…³é—­çª—å£æˆ–æŒ‰ `Q` é”®

---

## ðŸ“Š ç®—æ³•å¯¹æ¯”

### Spiralï¼ˆèžºæ—‹ç®—æ³•ï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… å‡ ä½•å‚æ•°ç›´è§‚ï¼ˆç›´å¾„ã€é«˜åº¦ã€å¼€å£è§’ï¼‰
- âœ… è·¯å¾„è¿žç»­æ€§å¥½
- âœ… é€‚åˆè§„åˆ™å½¢çŠ¶

**ç¼ºç‚¹ï¼š**
- âŒ éœ€è¦å‡ ä½•å‡è®¾ï¼ˆåœ†æŸ±å½¢ï¼‰
- âŒ å¯¹ä¸è§„åˆ™å½¢çŠ¶é€‚åº”æ€§å·®

**é€‚ç”¨åœºæ™¯ï¼š**
- æ ‡å‡†å°ä¾¿æ± ï¼ˆåœ†æŸ±/åœ†é”¥å½¢ï¼‰
- å½¢çŠ¶è§„åˆ™çš„è¡¨é¢

### Alpha Shapeï¼ˆæŽ¨èï¼‰

**ä¼˜ç‚¹ï¼š**
- âœ… æ— éœ€å‡ ä½•å‡è®¾
- âœ… é€‚åº”ä¸è§„åˆ™å½¢çŠ¶
- âœ… åˆ†å±‚è¦†ç›–å‡åŒ€
- âœ… æ”¯æŒå¹³é¢æ£€æµ‹

**ç¼ºç‚¹ï¼š**
- âŒ å‚æ•°è°ƒä¼˜è¾ƒå¤æ‚ï¼ˆalphaå€¼ï¼‰
- âŒ è®¡ç®—é‡ç¨å¤§

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¸è§„åˆ™å°ä¾¿æ± 
- å¤æ‚æ›²é¢
- **é»˜è®¤æŽ¨èä½¿ç”¨**

---

## ðŸ”¬ å‚æ•°è°ƒä¼˜æŒ‡å—

### é—®é¢˜ï¼šè·¯å¾„ç‚¹å¤ªç¨€ç–

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å‡å°ç‚¹é—´è·
--point-distance 0.005  # é»˜è®¤0.01

# å¢žåŠ åˆ†å±‚æ•°
--layers 20  # é»˜è®¤10
```

### é—®é¢˜ï¼šè·¯å¾„æœ‰æ˜Žæ˜¾ç©ºæ´ž

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å¢žå¤§Alphaå€¼ï¼ˆè½®å»“æ›´æ¾å¼›ï¼‰
--alpha 0.25  # é»˜è®¤0.20

# å‡å°ä½“ç´ å¤§å°ï¼ˆä¿ç•™æ›´å¤šç»†èŠ‚ï¼‰
--voxel 0.003  # é»˜è®¤0.005
```

### é—®é¢˜ï¼šè·¯å¾„æœ‰å¾ˆå¤šå™ªå£°ç‚¹

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# å¢žå¤§ä½“ç´ å¤§å°ï¼ˆæ›´æ¿€è¿›çš„ä¸‹é‡‡æ ·ï¼‰
--voxel 0.008  # é»˜è®¤0.005

# å‡å°Alphaå€¼ï¼ˆè½®å»“æ›´ç´§å¯†ï¼‰
--alpha 0.15  # é»˜è®¤0.20
```

### é—®é¢˜ï¼šè·¯å¾„è´´åˆåº¦ä¸å¤Ÿ

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# ä½¿ç”¨Alpha Shapeç®—æ³•
--algorithm alpha_shape

# å¢žåŠ åˆ†å±‚æ•°
--layers 15

# å‡å°ä½“ç´ å¤§å°
--voxel 0.003
```

---

## ðŸ“ å®Œæ•´ç¤ºä¾‹

### ç¤ºä¾‹1: æ ‡å‡†å°ä¾¿æ± ï¼ˆAlpha Shapeï¼‰

```bash
python3 urinal_path_planner_pcd.py \
    --input /path/to/urinal.pcd \
    --algorithm alpha_shape \
    --alpha 0.20 \
    --layers 10 \
    --voxel 0.005 \
    --output urinal_path_alpha.txt \
    --visualize
```

### ç¤ºä¾‹2: ä¸è§„åˆ™å°ä¾¿æ± ï¼ˆç»†å¯†è·¯å¾„ï¼‰

```bash
python3 urinal_path_planner_pcd.py \
    --input irregular_urinal.pcd \
    --algorithm alpha_shape \
    --alpha 0.18 \
    --layers 15 \
    --voxel 0.003 \
    --point-distance 0.005 \
    --output dense_path.txt \
    --visualize
```

### ç¤ºä¾‹3: å¿«é€Ÿæµ‹è¯•ï¼ˆèžºæ—‹ç®—æ³•ï¼‰

```bash
python3 urinal_path_planner_pcd.py \
    --input test_urinal.pcd \
    --algorithm spiral \
    --voxel 0.008 \
    --visualize
```

### ç¤ºä¾‹4: æ‰¹å¤„ç†å¤šä¸ªPCD

```bash
#!/bin/bash
# batch_process.sh

for pcd in *.pcd; do
    echo "Processing: $pcd"
    python3 urinal_path_planner_pcd.py \
        --input "$pcd" \
        --output "${pcd%.pcd}_path.txt" \
        --algorithm alpha_shape \
        --layers 12
done
```

---

## ðŸ› æ•…éšœæŽ’é™¤

### é”™è¯¯ï¼š`FileNotFoundError: PCDæ–‡ä»¶ä¸å­˜åœ¨`

**åŽŸå› ï¼š** è¾“å…¥è·¯å¾„é”™è¯¯

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /path/to/your_file.pcd

# ä½¿ç”¨ç»å¯¹è·¯å¾„
python3 urinal_path_planner_pcd.py --input /absolute/path/to/file.pcd
```

### é”™è¯¯ï¼š`ValueError: PCDæ–‡ä»¶ä¸ºç©º`

**åŽŸå› ï¼š** PCDæ–‡ä»¶æ²¡æœ‰ç‚¹äº‘æ•°æ®

**è§£å†³ï¼š**
```bash
# æ£€æŸ¥PCDæ–‡ä»¶å†…å®¹
head -20 your_file.pcd

# ç¡®ä¿æœ‰POINTSæ•°æ®æ®µ
```

### é”™è¯¯ï¼š`ValueError: è·¯å¾„ç”Ÿæˆå¤±è´¥`

**åŽŸå› ï¼š** ç‚¹äº‘è´¨é‡å·®æˆ–å‚æ•°ä¸åˆé€‚

**è§£å†³ï¼š**
```bash
# 1. å°è¯•è°ƒæ•´Alphaå€¼
--alpha 0.25  # å¢žå¤§

# 2. å°è¯•èžºæ—‹ç®—æ³•
--algorithm spiral

# 3. å‡å°‘é¢„å¤„ç†å¼ºåº¦
--voxel 0.008 --trim-top 0.00
```

### è­¦å‘Šï¼š`æœªæ‰¾åˆ°æœ‰æ•ˆæ®µ`

**åŽŸå› ï¼š** Alpha Shapeè¿‡æ»¤å¤ªä¸¥æ ¼

**è§£å†³ï¼š**
```bash
# å¢žå¤§Alphaå€¼
--alpha 0.30

# å¢žåŠ åˆ†å±‚æ•°
--layers 15
```

---

## ðŸ”— ä¸ŽROSç‰ˆæœ¬å¯¹æ¯”

| ç‰¹æ€§ | ROSç‰ˆæœ¬ (`urinal_detector.py`) | PCDç‰ˆæœ¬ (`urinal_path_planner_pcd.py`) |
|------|--------------------------------|---------------------------------------|
| **è¾“å…¥** | ROS PointCloud2 topic | PCDæ–‡ä»¶ |
| **è¾“å‡º** | 7ä¸ªROS topics | æ–‡æœ¬æ–‡ä»¶ + å¯è§†åŒ– |
| **ä¾èµ–** | ROS, rospy, sensor_msgs | ä»…Open3D, NumPy |
| **ROIè£å‰ª** | âœ… æ”¯æŒ | âŒ å·²ç§»é™¤ |
| **å®žæ—¶å¤„ç†** | âœ… è®¢é˜…æ¨¡å¼ | âŒ æ‰¹å¤„ç†æ¨¡å¼ |
| **å¯è§†åŒ–** | RViz | Open3Dçª—å£ |
| **é€‚ç”¨åœºæ™¯** | æœºå™¨äººåœ¨çº¿è§„åˆ’ | ç¦»çº¿æµ‹è¯•ã€ç®—æ³•å¼€å‘ |

---

## ðŸ“– ä»£ç ç»“æž„

```python
UrinalPathPlanner
â”œâ”€â”€ __init__()              # åˆå§‹åŒ–é…ç½®
â”œâ”€â”€ load_pcd()              # åŠ è½½PCDæ–‡ä»¶
â”œâ”€â”€ preprocess_pcd()        # é¢„å¤„ç†ï¼ˆä¸‹é‡‡æ ·ã€åŽ»å™ªã€æ³•å‘é‡ï¼‰
â”œâ”€â”€ generate_path()         # ä¸»è·¯å¾„ç”Ÿæˆ
â”‚   â”œâ”€â”€ _generate_path_spiral()      # èžºæ—‹ç®—æ³•
â”‚   â””â”€â”€ _generate_path_alpha_shape() # Alpha Shapeç®—æ³•
â”œâ”€â”€ visualize()             # 3Då¯è§†åŒ–
â””â”€â”€ save_path()             # ä¿å­˜è·¯å¾„æ–‡ä»¶

æ ¸å¿ƒç®—æ³•ï¼ˆä»Žurinal_detector.pyç§»æ¤ï¼‰:
â”œâ”€â”€ _analyze_urinal_geometry()    # å‡ ä½•åˆ†æž
â”œâ”€â”€ _generate_spiral_path()       # èžºæ—‹è·¯å¾„
â”œâ”€â”€ _detect_plane_simple()        # å¹³é¢æ£€æµ‹
â”œâ”€â”€ _generate_layered_path()      # åˆ†å±‚è·¯å¾„
â”œâ”€â”€ _generate_layer_contour()     # å•å±‚è½®å»“
â”œâ”€â”€ _alpha_shape_2d()             # 2D Alpha Shape
â””â”€â”€ _add_orientation_to_path()    # æ·»åŠ RPYå§¿æ€
```

---

## ðŸŽ¯ ä¸‹ä¸€æ­¥

1. **æµ‹è¯•è„šæœ¬**
   ```bash
   # ä½¿ç”¨ç¤ºä¾‹PCDæ–‡ä»¶æµ‹è¯•
   python3 urinal_path_planner_pcd.py --input test.pcd --visualize
   ```

2. **è°ƒæ•´å‚æ•°**
   - æ ¹æ®å®žé™…ç‚¹äº‘è´¨é‡è°ƒæ•´ `--voxel`, `--alpha`
   - è§‚å¯Ÿå¯è§†åŒ–ç»“æžœï¼Œä¼˜åŒ–åˆ†å±‚æ•°

3. **é›†æˆåˆ°å·¥ä½œæµ**
   - å°†ç”Ÿæˆçš„è·¯å¾„æ–‡ä»¶å¯¼å…¥MoveIt
   - æˆ–è½¬æ¢ä¸ºæœºå™¨äººæŒ‡ä»¤

---

## ðŸ“ž æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. Open3Dç‰ˆæœ¬ >= 0.13
2. PCDæ–‡ä»¶æ ¼å¼æ­£ç¡®
3. å‚æ•°è®¾ç½®åˆç†

è°ƒè¯•å»ºè®®ï¼š
```bash
# å¯ç”¨è¯¦ç»†è¾“å‡º
python3 urinal_path_planner_pcd.py --input test.pcd --visualize 2>&1 | tee debug.log
```

---

**åˆ›å»ºæ—¥æœŸï¼š** 2026å¹´1æœˆ16æ—¥  
**ç‰ˆæœ¬ï¼š** 1.0.0  
**åŸºäºŽï¼š** `urinal_detector.py` v2.0.0
