# 32_cleanpath_by_layer_and_plane.py - 代码说明

## 概述

基于点云的分层路径规划系统，用于生成清洁机器人等应用的完整覆盖路径。

**核心功能**：
- **平面部分**：往复扫描路径（Raster/Zigzag）
- **剩余部分**：边界环形路径（Alpha Shape + 移动平滑）

## 核心算法

### 1. 平面检测与分割
- **RANSAC** 检测近似水平平面（角度≤10°）
- **Z向带状膨胀** 扩展平面区域（±20mm）
- 分离平面部分和剩余部分

### 2. 平面路径生成 (`generate_plane_raster_path`) ⭐ 新增

#### 策略：往复扫描（Raster）
```
  v1 (长轴) →
┌─────────────────┐
│ →→→→→→→→→→→→→→ │  ← 扫描线1
│ ←←←←←←←←←←←←←← │  ← 扫描线2（反向）
│ →→→→→→→→→→→→→→ │  ← 扫描线3
│ ←←←←←←←←←←←←←← │
└─────────────────┘
  ↑ v2方向间距
```

#### 实现步骤：
1. **PCA分解**
   - v1: 长轴（主扫描方向）
   - v2: 短轴（进给方向）
   - v3: 法向（垂直平面）

2. **生成扫描线**
   - 沿v2方向，间距=15mm（可调）
   - 每条扫描线沿v1方向延伸
   
3. **边界裁剪**
   - 使用凸包计算平面边界
   - 裁剪每条扫描线到边界内
   - 保留有效段

4. **蛇形路径**
   - 奇数行：v1正向
   - 偶数行：v1反向
   - 连续路径，无空移

5. **采样**
   - 沿扫描线步长=5mm（可调）
   - 法向=平面法向（全部相同）

### 3. 剩余部分路径生成 (`generate_layer_path`)

对非平面区域的每一层生成**边界环形路径**（注意：仅边界，不覆盖内部）

#### 流程：
1. **DBSCAN聚类** - 提取最大连续区域
2. **PCA降维** - 投影到2D主平面
3. **Alpha Shape边界提取** - 保留凹形状，失败时退化到凸包
4. **移动平均平滑** - 三角窗口权重[1,2,3,2,1]/9
5. **法向估计** - KNN查询，朝向质心，z向上

## 关键参数

```python
# 平面路径（往复扫描）
ENABLE_PLANE_PATH        = True     # 启用平面路径
PLANE_RASTER_SPACING     = 0.015    # 扫描线间距（15mm）
PLANE_RASTER_STEP        = 0.005    # 采样步长（5mm）

# 剩余层路径（边界环形）
ALPHA_SHAPE_ALPHA   = 0.15      # 控制凹度
SMOOTH_WINDOW       = 5         # 移动平均窗口
K_NN                = 8         # 法向近邻数
STITCH_MODE         = 'straight'  # 层间连接: smooth/retract/straight
```

## 可视化

- **点云**: 按层彩色（暖色=平面，冷色=剩余）
- **平面路径**: 紫色线段
  - 起点：黄色球 ⭐
  - 终点：青色球 ⭐
- **剩余层路径**: 黑色环形
  - 起点：绿色球
  - 终点：红色球
- **连接器**: 红色线段
- **法向**: 蓝色箭头
- **走向**: 橙色箭头

## 输出示例

```
[INFO] plane PCA λ=[0.0208542,0.00306966,4.91355e-05]
  [PLANE RASTER] 范围: v1=[-0.250, 0.258]m, v2=[-0.096, 0.098]m
  [PLANE RASTER] 扫描线数量: 13, 间距=15.0mm
  [PLANE RASTER] 使用凸包边界: 31个顶点
  [PLANE RASTER] 生成路径: 1202个点, 12条扫描线 ⭐
[INFO] 平面路径起点(黄色): (0.1725, -0.6410, -0.1710)
[INFO] 平面路径终点(青色): (0.1855, -0.4762, -0.1683)

[INFO] Generating paths for 4 remain layers...
  [INFO] Alpha Shape: 从211点中提取211个边界点
[REMAIN PATH 01] n_points=211  z_mid=-0.09635
[INFO] Final stitched path: 328 points
```

## 技术亮点

1. **往复扫描** - 平面区域完整覆盖，无遗漏 ⭐
2. **凸包裁剪** - 自动适应平面边界形状
3. **蛇形路径** - 减少空移，提高效率
4. **Alpha Shape** - 剩余部分保留凹形状
5. **多层验证** - 自交/角度/间隙检测

## 适用场景

- **平面部分**：水槽底部、台面等规则表面（完整覆盖）
- **剩余部分**：侧壁、曲面等复杂形状（边界环形）
- 清洁机器人、喷涂、抛光等应用

## 注意事项

- ✅ 平面路径使用**往复扫描**，完整覆盖
- ⚠️ 剩余层路径仅为**边界环形**，不覆盖内部
- 扫描线间距需根据刀具宽度调整
- 平面识别依赖RANSAC参数
